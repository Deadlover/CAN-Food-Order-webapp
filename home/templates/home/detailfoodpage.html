{% extends 'home/cart.html' %}
{% load static %}

{% block all_content %}
<section class="block min-h-screen mt-36 max-sm:text-sm">
    <div class="flex justify-evenly">
        <div class=" flex w-4/5 justify-evenly shadow p-10">
            <div class="w-1/3">
                <img src="{{fooditem.image.url}}" alt="{{fooditem.Name}}">
            </div>
            <div class="w-1/3">

                <div>
                    <p class="text-2xl">{{fooditem.Name}}</p>
                    <p class="my-2 text-lg">{{fooditem.descriptions}}</p>
                    <p class="text-indigo-500 m-2">Remaining In Stock: {{fooditem.quantity}}</p>
                    <p>${{fooditem.price}}</p>
                    <div class="flex">
                        <p id="rating-container"></p>
                        <p class="ml-2" style="font-size: 17px;line-height: 2;">({{fooditem.average_rating}})</p>
                    </div>
                    {{fooditem.average_rating|json_script:"starrate"}}
                    <p>rated by {{fooditem.total_ratings_count}}</p>
                </div>

                <div class=" mt-14 ml-80">
                    <form action="" method="post" id="myForm">
                        {%csrf_token%}
                        <button data-product-id={{fooditem.id}} class="productId border border-yellow-400 px-5 py-2
                        hover:text-white hover:bg-yellow-400 buttonactive" onclick="click">Add</button>
                    </form>
                </div>

            </div>
        </div>
    </div>

    <div class="flex  justify-evenly mt-16">

        <form method="POST" action="" id="Comment" class="w-2/4">
            {% csrf_token %}
            <input type="number" hidden value="{{fooditem.id}}" name="foodid">
            <div class="star-rating flex " id="card-content">
                <input id="star-5" type="radio" name="rating" value="5" />
                <label for="star-5" title="5 stars">
                    &#9733; <!-- This is the HTML entity for a star -->
                </label>
                <input id="star-4" type="radio" name="rating" value="4" />
                <label for="star-4" title="4 stars">
                    &#9733;
                </label>
                <input id="star-3" type="radio" name="rating" value="3" />
                <label for="star-3" title="3 stars" class="text-red-500">
                    &#9733;
                </label>
                <input id="star-2" type="radio" name="rating" value="2" />
                <label for="star-2" title="2 stars">
                    &#9733;
                </label>
                <input id="star-1" type="radio" name="rating" value="1" />
                <label for="star-1" title="1 star">
                    &#9733;
                </label>
            </div>

            <div class="mt-6">
                <input type="text" class="border-b border-black px-2 py-1 w-full block outline-none " name="comment">
            </div>
            <button class="mt-4 border border-yellow-400 px-5 py-2
                hover:text-white hover:bg-yellow-400 buttonactive">Comment</button>
        </form>

    </div>
    <div class="flex flex-col items-center my-6">
        {% if review %}
        {% for review in review %}
        <div class="shadow p-4 w-2/4">

            <div class="flex text-yellow-300 flex-row-reverse text-2xl ">
                {% for i in review.score|get_range %}
                <p>&#9733;</p>
                {% endfor %}
            </div>

            <div class="flex">
                <img src="{{review.user.profile_picture.url}}" alt="" class="rounded-full w-14">
                <div>

                    <p class="ml-5 m-auto font-bold">{{review.user.email}}</p>
                    <p class="ml-10 m-auto">{{review.review}}</p>
                </div>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>
</section>
{% endblock %}

{% block javascript %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('myForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent the default form submission
            submitFormAjax(event); // Call the AJAX submission function
        });

        function submitFormAjax(e) {
            let btn = e.target.querySelector('button[data-product-id]'); // Assuming button is inside the form
            let url = '/add_to_cart/';
            let xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);

            let data = {
                'food_item_id': btn.getAttribute("data-product-id"),
            };

            let jsonData = JSON.stringify(data);
            let csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
            xhr.setRequestHeader('X-CSRFToken', csrfToken);

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    let responseData = JSON.parse(xhr.responseText);
                    if (responseData['msg'] == "out of stock") {
                        btn.style.display = "none";
                        // Ensure you have an element with ID 'outOfStockMessage' in your HTML
                        document.getElementById('outOfStockMessage').style.display = "block";
                        console.log(responseData['msg']);
                    }
                } else if (xhr.readyState === 4 && xhr.status !== 200) {
                    console.error("Request failed with status: " + xhr.status);
                }
            };

            xhr.send(jsonData);
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('Comment').addEventListener('submit', function (event) {
            // event.preventDefault(); // Prevent the default form submission
            submitCommentForm(event); // Call the AJAX submission function

        });

        function submitCommentForm(e) {
            //foodid
            let foodid = event.target.querySelector('input[name="foodid"]');


            // rating
            let radios = event.target.querySelectorAll('input[name="rating"]');
            let checkedRadio = Array.from(radios).find(radio => radio.checked);

            if (checkedRadio) {
                console.log(checkedRadio.value); // Logs the value of the checked radio button
            } else {
                console.log('No radio button is checked');
            }

            // comment
            let cmt = e.target.querySelector('input[name=comment]'); // Assuming button is inside the form
            console.log(foodid.value);

            if (!(checkedRadio || cmt.value)) {
                console.log("cmt or rate ");
                return false
            }


            let url = '/review/';
            let xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);

            let data = {
                'comment': cmt.value,
                'rating': checkedRadio.value,
                'foodid': foodid.value
            };

            let jsonData = JSON.stringify(data);
            console.log(jsonData);
            let csrfToken = e.target.querySelector('input[name=csrfmiddlewaretoken]').value;
            xhr.setRequestHeader('X-CSRFToken', csrfToken);

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    let responseData = JSON.parse(xhr.responseText);
                    console.log(responseData);
                } else if (xhr.readyState === 4 && xhr.status !== 200) {
                    console.error("Request failed with status: " + xhr.status);
                }
            };

            xhr.send(jsonData);
        }
    });



    // to show stars 
    let rate = parseFloat(document.getElementById('starrate').textContent)
    function adjust_rating(rate) {

        if (rate == 0) {
            return rate
        }
        // Convert the fractional part of the rating to 0.5 if it's between 0.1-0.4 or 0.6-0.9
        else {
            inrate = parseInt(rate)
            if ((rate-inrate) != 0) {
                if (0.1 <= rate % 1 <= 0.4 || 0.6 <= rate % 1 <= 0.9)
                    return parseInt(rate) + 0.5
                else
                    return round(rate)
            }
            else
                return rate   
        }
    }
    let finalrate = adjust_rating(rate)
    console.log(finalrate);

    displayRating(finalrate)

    function displayRating(finalrate) {
        const container = document.getElementById('rating-container');
        const totalStars = 5;
        let ratingCopy = finalrate;
        console.log(finalrate);

        for (let i = 1; i <= totalStars; i++) {
            if (ratingCopy >= 1) {
                // Full star
                container.innerHTML += '<span class="star-rating">&#9733;</span>';
                ratingCopy -= 1;
                console.log(ratingCopy);
            } else if (ratingCopy >= 0.5) {
                // Half star
                container.innerHTML += '<i class="fa fa-star-half-full text-yellow-300" style="font-size:24px"></i>'; // Add full star visually
                // container.innerHTML += `<span style="position: relative; font-size: 24px; left: -20px; color: lightgray;">&#9733;</span>`; // Overlay half with empty star for the half effect
                ratingCopy -= 0.5;
            } else {
                // Empty star
                container.innerHTML += '<span class="star-empty">&#9733;</span>';
            }
        }
    }

// for selecting star which gave error
    // document.addEventListener('mouseup', e => {
    //     let container = document.getElementById('card-content');

    //     if (container && !container.contains(e.target)) {
    //         document.querySelectorAll('input[type=radio][name="rating"]').forEach(radio => {
    //             console.log(radio.checked);
    //             if (radio.checked) {
    //                 radio.checked = false;
    //             }
    //         });
    //     }
    // });

    const dropbutton = document.querySelector('#user-menu-button');
    dropbutton.addEventListener('click', function () {
      const dropdown = document.querySelector('#user-dropdown');
      if (dropdown.style.display === "none" || dropdown.style.display === "") {
        dropdown.style.display = "block";
      } else {
        dropdown.style.display = "none";
      }
    });

    function openmenu() {
        const dropdown = document.querySelector('#setting-menu');
        if (dropdown.style.display === "none" || dropdown.style.display === "") {
            dropdown.style.display = "block";
        } else {
            dropdown.style.display = "none";
        }
    }

    document.getElementById("hamburger").addEventListener('click', function (event) {
      var hamm = document.getElementById('hamm');
      if (hamm.style.display === "none" || hamm.style.display === "") {
        hamm.style.display = "block";
      } else {
        hamm.style.display = "none";
      }
      event.stopPropagation(); // Prevent click from immediately bubbling to document
    });

    // Hide 'hamm' when clicking outside
    document.addEventListener('click', function (event) {
      var hamm = document.getElementById('hamm');
      var clickedElement = event.target; // The element that was clicked

      // Check if the clicked element is not the hamburger and not the hamm
      if (!clickedElement.closest('#hamburger') && !clickedElement.closest('#hamm')) {
        hamm.style.display = "none";
      }
    });


</script>
{% endblock %}